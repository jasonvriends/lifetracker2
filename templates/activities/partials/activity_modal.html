<!-- Activity Modal -->
<div id="activityModal" tabindex="-1" aria-hidden="true" class="fixed top-0 left-0 right-0 z-50 hidden w-full p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-[calc(100%-1rem)] max-h-full">
    <div class="relative w-full max-w-2xl max-h-full">
        <div class="relative bg-white rounded-lg shadow dark:bg-gray-700">
            <!-- Modal header -->
            <div class="flex items-start justify-between p-4 border-b rounded-t dark:border-gray-600">
                <h3 class="text-xl font-semibold text-gray-900 dark:text-white">
                    Add New Activity
                </h3>
                <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ml-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="activityModal">
                    <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
                    </svg>
                    <span class="sr-only">Close modal</span>
                </button>
            </div>
            
            <!-- Modal body -->
            <div class="p-6">
                <div class="flex gap-6">
                    <!-- Left side - Category Selection -->
                    <div class="w-1/4">
                        <label for="category-select" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Category</label>
                        <select id="category-select" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" required>
                            <option value="">Select a category</option>
                            {% for category in categories %}
                                <option value="{{ category.slug }}" {% if category.slug == default_category %}selected{% endif %}>
                                    {{ category.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Right side - Category-specific forms -->
                    <div class="w-3/4">
                        <!-- Basic Activity Form (hidden by default) -->
                        <form id="basic-activity-form" class="hidden">
                            {% csrf_token %}
                            <input type="hidden" name="category" id="activity-category">
                            <div class="space-y-4">
                                <div>
                                    <label for="name" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Name</label>
                                    <input type="text" id="name" name="name" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" required>
                                </div>
                                <div class="flex items-center">
                                    <input id="favorite" type="checkbox" name="favorite" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                    <label for="favorite" class="ml-2 text-sm font-medium text-gray-900 dark:text-white">Mark as favorite</label>
                                </div>
                            </div>
                        </form>

                        <!-- Consumption Activity Form -->
                        <form id="consume-activity-form" class="hidden">
                            {% csrf_token %}
                            <input type="hidden" name="category" value="consume">
                            <div class="space-y-4">
                                <div>
                                    <label for="consume-name" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Name</label>
                                    <input type="text" id="consume-name" name="name" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" required>
                                </div>
                                <div>
                                    <label for="consumption-description" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Consumption Description</label>
                                    <textarea id="consumption-description" name="consumption_description" rows="3" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white"></textarea>
                                </div>
                                <div>
                                    <label for="ingredients" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Ingredients (one per line)</label>
                                    <textarea id="ingredients" name="ingredients" rows="4" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white"></textarea>
                                </div>
                                <div class="grid gap-6 mb-6 md:grid-cols-2">
                                    <div>
                                        <label for="consumed-at-date" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Date consumed</label>
                                        <input type="date" id="consumed-at-date" name="consumed_at_date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white">
                                    </div>
                                    <div>
                                        <label for="consumed-at-time" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Time consumed</label>
                                        <input type="time" id="consumed-at-time" name="consumed_at_time" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white">
                                    </div>
                                </div>
                                <div class="flex items-center">
                                    <input id="consume-favorite" type="checkbox" name="favorite" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                    <label for="consume-favorite" class="ml-2 text-sm font-medium text-gray-900 dark:text-white">Mark as favorite</label>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Modal footer -->
            <div class="flex items-center p-6 space-x-2 border-t border-gray-200 rounded-b dark:border-gray-600">
                <button type="button" id="submit-activity" class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">Create Activity</button>
                <button type="button" class="text-gray-500 bg-white hover:bg-gray-100 focus:ring-4 focus:outline-none focus:ring-blue-300 rounded-lg border border-gray-200 text-sm font-medium px-5 py-2.5 hover:text-gray-900 focus:z-10 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-500 dark:hover:text-white dark:hover:bg-gray-600 dark:focus:ring-gray-600" data-modal-hide="activityModal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toast-container" class="fixed top-4 right-4 z-50"></div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const categorySelect = document.getElementById('category-select');
        const basicActivityForm = document.getElementById('basic-activity-form');
        const consumeActivityForm = document.getElementById('consume-activity-form');
        const activityCategoryInput = document.getElementById('activity-category');
        const submitButton = document.getElementById('submit-activity');

        // Function to show toast notification
        function showToast(message, type = 'success') {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `flex items-center w-full max-w-xs p-4 mb-4 text-gray-500 bg-white rounded-lg shadow dark:text-gray-400 dark:bg-gray-800 ${
                type === 'success' ? 'border-l-4 border-green-500' : 'border-l-4 border-red-500'
            }`;
            
            const icon = document.createElement('div');
            icon.className = `inline-flex items-center justify-center flex-shrink-0 w-8 h-8 ${
                type === 'success' ? 'text-green-500' : 'text-red-500'
            }`;
            icon.innerHTML = type === 'success' 
                ? '<svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20"><path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5Zm3.707 8.207-4 4a1 1 0 0 1-1.414 0l-2-2a1 1 0 0 1 1.414-1.414L9 10.586l3.293-3.293a1 1 0 0 1 1.414 1.414Z"/></svg>'
                : '<svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20"><path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5Zm3.707 11.793a1 1 0 1 1-1.414 1.414L10 11.414l-2.293 2.293a1 1 0 1 1-1.414-1.414L8.586 10 6.293 7.707a1 1 0 0 1 1.414-1.414L10 8.586l2.293-2.293a1 1 0 0 1 1.414 1.414L11.414 10l2.293 2.293Z"/></svg>';
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'ml-3 text-sm font-normal';
            messageDiv.textContent = message;
            
            toast.appendChild(icon);
            toast.appendChild(messageDiv);
            toastContainer.appendChild(toast);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // Function to update category-specific forms
        function updateCategoryForms() {
            const selectedCategory = categorySelect.value;
            activityCategoryInput.value = selectedCategory;

            // Hide all forms first
            basicActivityForm.style.display = 'none';
            consumeActivityForm.style.display = 'none';

            // Show form for selected category
            if (selectedCategory === 'consume') {
                consumeActivityForm.style.display = 'block';
                // Set default date/time to now
                const now = new Date();
                document.getElementById('consumed-at-date').value = now.toISOString().split('T')[0];
                document.getElementById('consumed-at-time').value = now.toTimeString().slice(0, 5);
            } else if (selectedCategory) {
                basicActivityForm.style.display = 'block';
            }
        }

        // Function to get form data
        function getFormData(form) {
            const formData = new FormData(form);
            const data = {};
            
            // Process form data
            for (let [key, value] of formData.entries()) {
                if (key === 'ingredients') {
                    data[key] = value.split('\n').filter(i => i.trim());
                } else if (key === 'consumed_at_date' && formData.get('consumed_at_time')) {
                    const date = value;
                    const time = formData.get('consumed_at_time');
                    data['date'] = date;
                    data['time'] = time;
                } else if (key === 'favorite') {
                    data[key] = value === 'on';
                } else if (key === 'consumption_description') {
                    data['description'] = value;
                } else if (key !== 'consumed_at_time' && key !== 'csrfmiddlewaretoken') {
                    data[key] = value;
                }
            }

            data['category'] = categorySelect.value;
            return data;
        }

        // Handle form submission
        submitButton.addEventListener('click', async function() {
            const selectedCategory = categorySelect.value;
            if (!selectedCategory) {
                showToast('Please select a category', 'error');
                return;
            }

            const form = selectedCategory === 'consume' ? consumeActivityForm : basicActivityForm;
            const formData = getFormData(form);

            try {
                const response = await fetch('{% url "activities:create" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (response.ok) {
                    showToast(result.message || 'Activity created successfully');
                    const modal = document.getElementById('activityModal');
                    modal.style.display = 'none';
                    window.location.reload();
                } else {
                    showToast(result.message || 'Error creating activity', 'error');
                }
            } catch (error) {
                showToast('Error creating activity', 'error');
            }
        });

        // Update forms when category changes
        categorySelect.addEventListener('change', updateCategoryForms);

        // Initial update
        updateCategoryForms();
    });
</script> 